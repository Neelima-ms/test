name: Automerge

on:
 push:
     branches:
       - 'release/*'

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
#     strategy:
#       matrix:
#         node-version: [14.x]
    steps:
      - name: Checkout code 
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.ref }}
#       - name: Use Node.js ${{ matrix.node-version }}
#         uses: actions/setup-node@2
#         with: 
#           node-version: ${{ matrix.node-version }}
          
#       - name: Install dependenceies
#         run: npm ci
      - name: Merge Release Branches to Default Branch
        uses: pullreminders/merge@v1
        with:
          github_token: ${{ secrets.GITHUB-TOKEN }}
          branch: ${{ github.ref }}
          method: squash
        
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: check for merge conflicts
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "merge conflct detected"
            echo "$(git status)"
            echo "conflicts detected in the default branch or release branch" | mail -s "Merge conflict" neelimamddela95@gmail.com
            exit 1
            fi
            
      - name: Send email notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Auto-Merge failed for release branch"
          body: "There were merge conflicts while attempting to auto-merge the release branch."
#           from: Neelima
          to: "neelimamaddela95@gmail.com"
